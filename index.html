<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Family Holiday Task & Expense Planner</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        .card { background-color: white; border-radius: 0.75rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); transition: transform 0.2s, box-shadow 0.2s; }
        .card:hover { transform: translateY(-4px); box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1); }
        .btn-day, .btn-tab { transition: all 0.2s ease-in-out; }
        .btn-day.active, .btn-tab.active { background-color: #0d9488; color: white; }
        .btn-tab.active { transform: scale(1.05); }
        .chart-container { position: relative; width: 100%; height: 300px; }
        .hidden { display: none; }
        .person-badge { display: inline-flex; align-items: center; background-color: #f1f5f9; border-radius: 9999px; padding: 0.25rem 0.75rem; margin: 0.25rem; font-size: 0.875rem; font-weight: 500; }
        .person-color-dot { width: 0.75rem; height: 0.75rem; border-radius: 50%; margin-right: 0.5rem; border: 1px solid rgba(0,0,0,0.1); }
        .modal { position: fixed; inset: 0; background-color: rgba(0,0,0,0.6); display: flex; align-items: center; justify-content: center; z-index: 50; padding: 1rem; }
        .explanation-text { font-size: 0.875rem; color: #475569; margin-top: 0.5rem; padding: 0.75rem; background-color: #f8fafc; border-radius: 0.5rem; }
    </style>
</head>
<body class="text-slate-800">

    <div class="container mx-auto p-4 md:p-8 max-w-7xl">
        
        <!-- Welcome Modal -->
        <div id="welcome-modal" class="modal hidden">
            <div class="card p-8 text-center max-w-md w-full">
                <h2 class="text-2xl font-bold mb-2">Welcome to the Family Task Management System!</h2>
                <p class="text-slate-600 mb-6">Please enter your name to continue.</p>
                <form id="welcome-form">
                    <input type="text" id="user-name-input" placeholder="Your Name" required class="w-full p-3 border border-slate-300 rounded-lg mb-4">
                    <button type="submit" class="w-full px-6 py-3 bg-teal-600 text-white rounded-full font-semibold hover:bg-teal-700">Start Planning</button>
                </form>
            </div>
        </div>
        
        <!-- Setup Screen -->
        <div id="setup-screen" class="text-center hidden">
            <header class="text-center w-full mb-8"><h1 class="text-4xl font-bold">Holiday Planner Setup</h1><p class="mt-2 text-lg text-slate-600">No plan found. Please generate the first plan for the holiday.</p></header>
            <div class="max-w-xl mx-auto card p-8">
                <h2 class="text-2xl font-bold text-slate-800 mb-6">Select Holiday Dates to Generate a New Plan</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                    <div><label for="start-date" class="block text-sm font-medium text-left">Start Date</label><input type="date" id="start-date" class="w-full p-3 border border-slate-300 rounded-lg"></div>
                    <div><label for="end-date" class="block text-sm font-medium text-left">End Date</label><input type="date" id="end-date" class="w-full p-3 border border-slate-300 rounded-lg"></div>
                </div>
                <button id="generate-schedule-btn" class="w-full px-6 py-3 bg-teal-600 text-white rounded-full font-semibold">Generate Plan</button>
                <p id="date-error" class="text-red-500 mt-4 h-4"></p>
            </div>
        </div>

        <!-- Main App Screen -->
        <div id="main-app-screen" class="hidden">
            <header class="relative text-center w-full mb-8">
                <div class="absolute top-0 left-0 text-sm text-slate-500" id="user-display">User: </div>
                <h1 id="app-title" class="text-4xl md:text-5xl font-bold text-slate-900">Family Holiday Planner</h1>
                <p id="app-dates" class="mt-2 text-lg text-slate-600"></p>
                <button id="changelog-btn" class="absolute top-0 right-0 text-sm text-teal-600 hover:underline hidden">View Change Log</button>
            </header>

            <div class="mb-8 flex justify-center border-b border-slate-200">
                <button id="tab-tasks" class="btn-tab text-lg font-semibold py-3 px-6 -mb-px border-b-2 border-transparent">Task Planner</button>
                <button id="tab-expenses" class="btn-tab text-lg font-semibold py-3 px-6 -mb-px border-b-2 border-transparent">Expense Tracker</button>
            </div>

            <div id="content-tasks">
                 <main>
                    <section class="mb-8">
                        <h2 class="text-2xl font-bold mb-4 text-center">Select a Day</h2>
                        <div id="day-selector" class="flex items-center space-x-2 overflow-x-auto pb-4"></div>
                    </section>
                    <section id="daily-view" class="mb-12">
                        <h2 id="daily-view-title" class="text-3xl font-bold mb-6 text-center flex justify-center items-center"></h2>
                        <div id="task-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
                    </section>
                    <section class="p-6 md:p-8 card">
                        <h2 class="text-3xl font-bold mb-6 text-center">Analyze Tasks</h2>
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                            <div><h3 class="text-xl font-bold mb-4">See Personal Tasks</h3><select id="person-filter" class="w-full p-3 border rounded-lg"></select><div id="personal-task-list" class="mt-4 space-y-2 max-h-80 overflow-y-auto"></div></div>
                            <div><h3 class="text-xl font-bold mb-4">Family Task Distribution</h3><div class="chart-container"><canvas id="task-distribution-chart"></canvas></div></div>
                        </div>
                    </section>
                </main>
            </div>
            <div id="content-expenses" class="hidden">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <div class="lg:col-span-1 space-y-8">
                        <div class="card p-6"><h3 class="text-xl font-bold mb-4">Add New Expense</h3><form id="expense-form" class="space-y-4"><div><label for="expense-desc">Description</label><input type="text" id="expense-desc" required class="mt-1 w-full p-2 border rounded-md"></div><div><label for="expense-amount">Amount (€)</label><input type="number" id="expense-amount" step="0.01" required class="mt-1 w-full p-2 border rounded-md"></div><div><label for="expense-category">Category</label><select id="expense-category" required class="mt-1 w-full p-2 border rounded-md"><option>Groceries</option><option>Presents</option><option>Activities</option><option>Dining Out</option><option>Transport</option><option>Other</option></select></div><div><label for="expense-paid-by">Paid By</label><select id="expense-paid-by" required class="mt-1 w-full p-2 border rounded-md"></select></div><button type="submit" class="w-full px-4 py-2 bg-teal-600 text-white rounded-full">Add Expense</button></form></div>
                        <div class="card p-6"><h3 class="text-xl font-bold mb-4">Expense Log</h3><div id="expense-log" class="space-y-3 max-h-96 overflow-y-auto"></div></div>
                    </div>
                    <div class="lg:col-span-2 space-y-8">
                        <div class="card p-6">
                            <h3 class="text-xl font-bold mb-4">Shopping Financial Analysis</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                                <div>
                                    <h4 class="text-lg font-semibold text-center">Shopping Costs by Family</h4>
                                    <div class="chart-container"><canvas id="family-spending-chart"></canvas></div>
                                    <p class="explanation-text">This chart visualizes the total shopping amount spent by each household head.</p>
                                </div>
                                <div>
                                    <h4 class="text-lg font-semibold text-center">Spending by Category</h4>
                                    <div class="chart-container"><canvas id="category-chart"></canvas></div>
                                    <p class="explanation-text">This chart shows the percentage distribution of your shopping expenses across different categories.</p>
                                </div>
                            </div>
                        </div>
                        <div class="card p-6">
                            <h3 class="text-xl font-bold mb-4">Shopping Cost Distribution</h3>
                            <p class="explanation-text">The 'Owe / Owed' amount in the chart and table is calculated by first determining the total holiday shopping expenses. This total is then divided by the sum of 'units' for all families (where each person, adult or child, counts as one unit) to find the 'fair share' cost per unit. For each family, their 'expected contribution' is calculated by multiplying their total units by this 'fair share' cost. The 'Owe / Owed' value represents the difference between a family's 'Total Spent' (actual contribution) and their 'expected contribution'. A positive value means the family has overpaid and is owed money, while a negative value means they have underpaid and owe money.</p>
                            <div id="settlement-summary" class="mt-4 space-y-6">
                                <div id="balance-summary"></div>
                                <div id="settlement-plan"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="edit-task-modal" class="modal hidden"><div class="card p-8 w-full max-w-2xl"><h3 id="edit-modal-title" class="text-2xl font-bold mb-6"></h3><div id="edit-form-content" class="space-y-4"></div><div class="mt-8 flex justify-end space-x-4"><button id="cancel-edit-btn" class="px-6 py-2 bg-slate-200 rounded-full">Cancel</button><button id="save-edit-btn" class="px-6 py-2 bg-teal-600 text-white rounded-full">Save Changes</button></div></div></div>
    <div id="changelog-modal" class="modal hidden"><div class="card p-8 w-full max-w-3xl"><h3 class="text-2xl font-bold mb-6">Change Log</h3><div id="changelog-log" class="space-y-2 max-h-[70vh] overflow-y-auto"></div><div class="mt-8 text-right"><button id="close-changelog-btn" class="px-6 py-2 bg-teal-600 text-white rounded-full">Close</button></div></div></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        let appData = { schedule: [], expenses: [], history: [] };
        const family = {
            adults: ["Miguel", "Ankie", "Juan", "Marie", "David", "Mathilde", "Eva"],
            children: ["Noah", "Emma", "Mathias", "Florent", "Peneloppe"],
            taskableChildren: ["Noah", "Emma", "Mathias", "Florent"]
        };
        const familyUnits = {
            "Family Miguel": ["Miguel", "Ankie", "Noah", "Emma"],
            "Family Juan": ["Juan", "Marie", "Mathias", "Florent"],
            "Family David": ["David", "Mathilde", "Peneloppe"],
            "Family Eva": ["Eva"]
        };
        const personColors = { "Miguel": "#ef4444", "Ankie": "#f97316", "Juan": "#84cc16", "Marie": "#10b981", "David": "#06b6d4", "Mathilde": "#6366f1", "Eva": "#d946ef", "Noah": "#fde047", "Emma": "#fde047", "Mathias": "#fde047", "Florent": "#fde047" };
        let categoryChart, familySpendingChart, taskDistChart;
        let currentDayIndex = 0;
        let db, auth, userId, dataDocRef, currentUserName;

        const el = id => document.getElementById(id);

        async function initFirebase() {
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-holiday-planner';
            try {
                const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                await new Promise((resolve, reject) => {
                    onAuthStateChanged(auth, async (user) => {
                        if (user) { userId = user.uid; resolve(); } 
                        else {
                            try {
                                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) await signInWithCustomToken(auth, __initial_auth_token);
                                else await signInAnonymously(auth);
                                resolve();
                            } catch (error) { reject(error); }
                        }
                    });
                });
                dataDocRef = doc(db, "artifacts", appId, "public/data/plans", "mainPlan");
            } catch (error) { console.error("Firebase init failed:", error); }
        }

        function setupFirestoreListener() {
            if (!dataDocRef) {
                console.error("Firestore ref not initialized.");
                el('setup-screen').classList.remove('hidden');
                return;
            }
            onSnapshot(dataDocRef, (docSnap) => {
                if (docSnap.exists() && docSnap.data().appData) {
                    appData = JSON.parse(docSnap.data().appData);
                    if(!appData.expenses) appData.expenses = [];
                    if(!appData.history) appData.history = [];
                    el('setup-screen').classList.add('hidden');
                    el('main-app-screen').classList.remove('hidden');
                    initializeAppUI();
                } else { 
                    el('main-app-screen').classList.add('hidden');
                    el('setup-screen').classList.remove('hidden'); 
                }
            }, (error) => {
                console.error("Error with Firestore listener:", error);
                el('main-app-screen').classList.add('hidden');
                el('setup-screen').classList.remove('hidden');
            });
        }

        async function saveDataToFirestore() {
            if (!dataDocRef) return;
            try { await setDoc(dataDocRef, { appData: JSON.stringify(appData) }); } catch (error) { console.error("Error saving data: ", error); }
        }
        
        const dayNames = ["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"];
        function generateSchedule(startDate, endDate) {
            const newSchedule = []; let currentDate = new Date(startDate); const end = new Date(endDate);
            const taskCounts = [...family.adults, ...family.taskableChildren].reduce((acc, p) => ({...acc, [p]: 0}), {});

            const getLeastBusy = (people) => [...people].sort((a,b) => taskCounts[a] - taskCounts[b]);

            const eligibleCooks = family.adults.filter(p => p !== 'Mathilde');
            const eligibleShoppers = family.adults.filter(p => p !== 'Mathilde' && p !== 'Marie' && p !== 'Ankie');
            
            while(currentDate <= end) {
                const utcDate = new Date(Date.UTC(currentDate.getFullYear(), currentDate.getMonth(), currentDate.getDate()));
                const day = { date: utcDate.toISOString().split('T')[0], day: dayNames[utcDate.getUTCDay()], cooking: [], dressing: [], cleaning: [], houseCleaning: '', shopping:[], notes:"" };
                
                let availableAdultsThisDay = [...family.adults];
                let availableChildrenThisDay = [...family.taskableChildren];

                const assign = (people, count) => {
                    const assigned = [];
                    const leastBusy = getLeastBusy(people);
                    
                    for (const person of leastBusy) {
                        if (assigned.length >= count) break;
                        const isAdult = family.adults.includes(person);
                        const isChild = family.taskableChildren.includes(person);

                        if (isAdult && availableAdultsThisDay.includes(person)) {
                            assigned.push(person);
                            taskCounts[person]++;
                            availableAdultsThisDay.splice(availableAdultsThisDay.indexOf(person), 1);
                        } else if (isChild && availableChildrenThisDay.includes(person)) {
                            assigned.push(person);
                            taskCounts[person]++;
                            availableChildrenThisDay.splice(availableChildrenThisDay.indexOf(person), 1);
                        }
                    }
                    return assigned;
                };

                day.cooking = assign(eligibleCooks, 2);
                day.houseCleaning = assign(availableAdultsThisDay, 1)[0] || '';
                if(newSchedule.length % 2 === 0) day.shopping = assign(eligibleShoppers, 2);
                
                day.dressing = assign(family.taskableChildren, 2);
                day.cleaning = assign(availableChildrenThisDay, 2);
                
                newSchedule.push(day); currentDate.setDate(currentDate.getDate() + 1);
            }
            return newSchedule;
        }

        function initializeAppUI() {
            if (!appData.schedule || appData.schedule.length === 0) return;
            const firstDay = formatDate(appData.schedule[0].date);
            const lastDay = formatDate(appData.schedule[appData.schedule.length - 1].date);
            el('app-dates').textContent = `${firstDay} - ${lastDay}`;
            populatePersonFilter(); populateExpensePaidBySelect();
            renderAll();
        }

        function renderAll() {
            if (!appData.schedule || appData.schedule.length === 0) return;
            populateDaySelector(); displayDay(currentDayIndex); createTaskDistributionChart();
            displayPersonalTasks(el('person-filter').value);
            renderExpenseLog(); renderFinancialAnalysis();
            if(appData.history && appData.history.length > 0) el('changelog-btn').classList.remove('hidden');
            else el('changelog-btn').classList.add('hidden');
        }

        function populateDaySelector() {
            const daySelector = el('day-selector'); daySelector.innerHTML = '';
            appData.schedule.forEach((day, index) => {
                const btn = document.createElement('button');
                btn.className = 'btn-day flex-shrink-0 text-sm md:text-base font-semibold py-2 px-4 rounded-full bg-white shadow-sm';
                if(index === currentDayIndex) btn.classList.add('active');
                const date = new Date(day.date);
                btn.innerHTML = `<span class="font-normal text-xs">${date.toLocaleDateString('en-US', {weekday: 'short', timeZone: 'UTC'})}</span> ${date.getUTCDate()}`;
                btn.onclick = () => { currentDayIndex = index; renderAll(); };
                daySelector.appendChild(btn);
            });
        }

        function displayDay(index) {
            const dayData = appData.schedule[index];
            if (!dayData) return;
            const titleEl = el('daily-view-title');
            titleEl.innerHTML = `${formatDate(dayData.date, { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}
                <button id="edit-day-btn" class="ml-4 text-sm bg-slate-200 px-3 py-1 rounded-full hover:bg-slate-300">Edit</button>`;
            el('edit-day-btn').onclick = () => openEditModal(index);
            
            el('task-grid').innerHTML = '';
            const createTaskCard = (title, people, icon) => {
                const personArray = Array.isArray(people) ? people : (people ? [people] : []);
                if (personArray.length === 0 || !personArray[0]) return;
                const card = document.createElement('div'); card.className = 'card p-6 flex flex-col items-center text-center';
                const peopleHTML = personArray.map(p => `<span class="person-badge"><span class="person-color-dot" style="background-color: ${personColors[p] || '#d1d5db'}"></span>${p}</span>`).join('');
                card.innerHTML = `<div class="text-4xl mb-3">${icon}</div><h3 class="text-xl font-bold mb-3">${title}</h3><div class="flex flex-wrap justify-center">${peopleHTML}</div>`;
                el('task-grid').appendChild(card);
            };
            createTaskCard('Cooking', dayData.cooking, '🍳');
            createTaskCard('House Cleaning', dayData.houseCleaning, '🧹');
            createTaskCard('Shopping', dayData.shopping, '🛒');
            createTaskCard('Dressing Table', dayData.dressing, '🍽️');
            createTaskCard('Cleaning Table', dayData.cleaning, '🧽');
        }

        function populatePersonFilter() {
            const personFilter = el('person-filter');
            personFilter.innerHTML = `<option value="all">Show All</option>`;
            [...family.adults, ...family.children].sort().forEach(p => personFilter.add(new Option(p, p)));
        }
        function populateExpensePaidBySelect() {
            const expensePaidBySelect = el('expense-paid-by');
            expensePaidBySelect.innerHTML = '';
            family.adults.forEach(p => expensePaidBySelect.add(new Option(p,p)));
        }
        function displayPersonalTasks(person) {
            const taskList = el('personal-task-list');
            taskList.innerHTML = '';
            if (person === 'all') return;
            const assignedTasks = [];
            appData.schedule.forEach(day => {
                const check = (taskData, taskName) => {
                    const people = Array.isArray(taskData) ? taskData : (taskData ? [taskData] : []);
                    if (people.includes(person)) {
                        assignedTasks.push({date: day.date, task: taskName});
                    }
                };
                check(day.cooking, 'Cooking');
                check(day.houseCleaning, 'House Cleaning');
                check(day.shopping, 'Shopping');
                check(day.dressing, 'Dressing Table');
                check(day.cleaning, 'Cleaning Table');
            });
            if(assignedTasks.length > 0) {
                taskList.innerHTML = assignedTasks.map(t => `<div class="p-2 bg-slate-100 rounded-lg flex justify-between"><span>${t.task}</span><span class="text-sm text-slate-500">${formatDate(t.date)}</span></div>`).join('');
            } else {
                taskList.innerHTML = `<p class="text-slate-500 text-center">${person} has no tasks.</p>`;
            }
        }
        function renderExpenseLog() {
            const logEl = el('expense-log');
            logEl.innerHTML = '';
            if (!appData.expenses || appData.expenses.length === 0) {
                logEl.innerHTML = '<p class="text-slate-500 text-center">No expenses added yet.</p>'; return;
            }
            [...appData.expenses].reverse().forEach(ex => {
                const div = document.createElement('div');
                div.className = 'p-3 bg-slate-100 rounded-lg flex justify-between items-center text-sm';
                div.innerHTML = `<div><p class="font-semibold">${ex.description}</p><p class="text-slate-500">${ex.paidBy} - ${ex.category}</p></div><span class="font-bold text-teal-700">€${ex.amount.toFixed(2)}</span>`;
                logEl.appendChild(div);
            });
        }
       
        function createTaskDistributionChart() {
            const counts = {}; const labels = [...family.adults, ...family.taskableChildren];
            labels.forEach(p => counts[p] = 0);
            appData.schedule.forEach(d => {
                const count = (p) => { if (Array.isArray(p)) p.forEach(name => {if(counts[name]!==undefined) counts[name]++}); else if(p && counts[p]!==undefined) counts[p]++; };
                count(d.cooking); count(d.houseCleaning); count(d.shopping); count(d.dressing); count(d.cleaning);
            });
            const data = labels.map(l => counts[l]);
            const colors = labels.map(l => family.children.includes(l) ? '#fde047' : '#14b8a6');
            updateChart('task-distribution-chart', 'bar', labels, data, colors);
        }

        function renderFinancialAnalysis() {
            if (!appData.expenses) appData.expenses = [];
            const shoppingExpenses = appData.expenses.filter(e => e.category === 'Groceries' || e.category === 'Presents');

            const catSpend = shoppingExpenses.reduce((a, e) => { a[e.category] = (a[e.category] || 0) + e.amount; return a; }, {});
            updateChart('category-chart', 'pie', Object.keys(catSpend), Object.values(catSpend));
            
            const familySpend = Object.keys(familyUnits).reduce((acc, unit) => {
                acc[unit] = shoppingExpenses.filter(e => familyUnits[unit].includes(e.paidBy)).reduce((s, e) => s + e.amount, 0); return acc;
            }, {});
            updateChart('family-spending-chart', 'pie', Object.keys(familySpend), Object.values(familySpend));

            const totalShoppingSpent = shoppingExpenses.reduce((s, e) => s + e.amount, 0);
            const totalUnits = family.adults.length + family.taskableChildren.length;
            const costPerUnit = totalUnits > 0 ? totalShoppingSpent / totalUnits : 0;
            
            const balances = Object.keys(familyUnits).reduce((acc, unit) => {
                const familySize = familyUnits[unit].filter(p => p !== 'Peneloppe').length;
                const expectedContribution = familySize * costPerUnit;
                const actualContribution = shoppingExpenses.filter(e => familyUnits[unit].includes(e.paidBy)).reduce((s, e) => s + e.amount, 0);
                acc[unit] = actualContribution - expectedContribution;
                return acc;
            }, {});

            const { owes, owed } = Object.entries(balances).reduce((acc, [name, balance]) => {
                if (balance > 0.01) acc.owed.push({ name, amount: balance });
                else if (balance < -0.01) acc.owes.push({ name, amount: Math.abs(balance) });
                return acc;
            }, { owes: [], owed: [] });

            el('balance-summary').innerHTML = `<div class="grid grid-cols-1 md:grid-cols-2 gap-6"><div><h4 class="text-lg font-semibold text-red-600">Who Owes</h4>${owes.length > 0 ? owes.map(p => `<p>${p.name}: €${p.amount.toFixed(2)}</p>`).join('') : '<p>All settled.</p>'}</div><div><h4 class="text-lg font-semibold text-green-600">Who Is Owed</h4>${owed.length > 0 ? owed.map(p => `<p>${p.name}: €${p.amount.toFixed(2)}</p>`).join('') : '<p>All settled.</p>'}</div></div>`;
            const settlementPlanResult = generateSettlementPlan(balances);
            el('settlement-plan').innerHTML = `<h4 class="font-semibold mt-4">Settlement Summary</h4><div class="p-4 bg-slate-50 rounded-lg">${settlementPlanResult}</div>`;
        }
        
        function updateChart(canvasId, type, labels, data, backgroundColors) {
            const ctx = el(canvasId).getContext('2d');
            const colors = ['#14b8a6', '#f97316', '#84cc16', '#6366f1', '#d946ef', '#2dd4bf'];
            let chartInstance;
            switch(canvasId) {
                case 'category-chart': if (categoryChart) categoryChart.destroy(); break;
                case 'family-spending-chart': if (familySpendingChart) familySpendingChart.destroy(); break;
                case 'task-distribution-chart': if (taskDistChart) taskDistChart.destroy(); break;
            }
            chartInstance = new Chart(ctx, { type, data: { labels, datasets: [{ label: type === 'bar' ? 'Count' : 'Amount (€)', data, backgroundColor: backgroundColors || colors }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: type === 'pie' } } } });
            switch(canvasId) {
                case 'category-chart': categoryChart = chartInstance; break;
                case 'family-spending-chart': familySpendingChart = chartInstance; break;
                case 'task-distribution-chart': taskDistChart = chartInstance; break;
            }
        }
        
        function generateSettlementPlan(balances) {
            let debtors = Object.entries(balances).filter(([, bal]) => bal < -0.01).map(([name, bal]) => ({ name, amount: -bal }));
            let creditors = Object.entries(balances).filter(([, bal]) => bal > 0.01).map(([name, bal]) => ({ name, amount: bal }));
            debtors.sort((a,b) => b.amount - a.amount); creditors.sort((a,b) => b.amount - a.amount);
            const transactions = [];
            while(debtors.length > 0 && creditors.length > 0) {
                const d = debtors[0], c = creditors[0], amount = Math.min(d.amount, c.amount);
                transactions.push(`<p>${d.name} pays ${c.name} <span class="font-bold">€${amount.toFixed(2)}</span></p>`);
                d.amount -= amount; c.amount -= amount;
                if (d.amount < 0.01) debtors.shift();
                if (c.amount < 0.01) creditors.shift();
            }
            return transactions.length > 0 ? transactions.join('') : '<p class="text-green-600 font-semibold">All expenses are balanced.</p>';
        }

        document.addEventListener('DOMContentLoaded', async () => {
            await initFirebase();
            currentUserName = localStorage.getItem('holidayPlannerUser');
            if (currentUserName) {
                el('user-display').textContent = `User: ${currentUserName}`;
                setupFirestoreListener();
            } else {
                el('welcome-modal').classList.remove('hidden');
            }
        });
        el('welcome-form').addEventListener('submit', (e) => {
            e.preventDefault();
            currentUserName = el('user-name-input').value;
            localStorage.setItem('holidayPlannerUser', currentUserName);
            el('welcome-modal').classList.add('hidden');
            el('user-display').textContent = `User: ${currentUserName}`;
            setupFirestoreListener();
        });
        el('generate-schedule-btn').addEventListener('click', async () => {
            const start = el('start-date').value, end = el('end-date').value;
            if (!start || !end || new Date(start) > new Date(end)) {
                 el('date-error').textContent = 'Please enter a valid date range.';
                 return;
            }
            el('date-error').textContent = '';
            
            const newAppData = {
                schedule: generateSchedule(start, end),
                expenses: [],
                history: []
            };
            appData = newAppData; // Update local state immediately
            await saveDataToFirestore(); // Save to Firestore
            // The onSnapshot listener will handle the UI update automatically
        });
        el('tab-tasks').addEventListener('click', (e) => { e.target.classList.add('active', 'border-teal-500'); el('tab-expenses').classList.remove('active', 'border-teal-500'); el('content-tasks').classList.remove('hidden'); el('content-expenses').classList.add('hidden'); });
        el('tab-expenses').addEventListener('click', (e) => { e.target.classList.add('active', 'border-teal-500'); el('tab-tasks').classList.remove('active', 'border-teal-500'); el('content-expenses').classList.remove('hidden'); el('content-tasks').classList.add('hidden'); });
        el('expense-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            appData.expenses.push({ id: crypto.randomUUID(), date: new Date().toISOString(), description: el('expense-desc').value, amount: parseFloat(el('expense-amount').value), category: el('expense-category').value, paidBy: el('expense-paid-by').value });
            await saveDataToFirestore();
            el('expense-form').reset();
        });
        el('person-filter').addEventListener('change', (e) => displayPersonalTasks(e.target.value));
        el('changelog-btn').addEventListener('click', () => { el('changelog-modal').classList.remove('hidden'); renderChangeLog(); });
        el('close-changelog-btn').addEventListener('click', () => el('changelog-modal').classList.add('hidden'));
        el('cancel-edit-btn').addEventListener('click', () => el('edit-task-modal').classList.add('hidden'));
        el('save-edit-btn').addEventListener('click', saveEditChanges);

        function openEditModal(dayIndex) {
            const dayData = appData.schedule[dayIndex];
            el('edit-modal-title').textContent = `Edit Tasks for ${formatDate(dayData.date)}`;
            const form = el('edit-form-content');
            form.innerHTML = '';
            
            const createSelect = (id, label, options, multiple, selected) => {
                const selectedArray = Array.isArray(selected) ? selected : (selected ? [selected] : []);
                let optionsHTML = options.map(o => `<option value="${o}" ${selectedArray.includes(o) ? 'selected' : ''}>${o}</option>`).join('');
                form.innerHTML += `<label for="${id}" class="block text-sm font-medium">${label}</label><select id="${id}" ${multiple ? 'multiple' : ''} class="w-full p-2 border rounded-md bg-white">${optionsHTML}</select>`;
            };

            createSelect('edit-cooking', 'Cooking', family.adults.filter(p=>p!=='Mathilde'), true, dayData.cooking);
            createSelect('edit-houseCleaning', 'House Cleaning', family.adults, false, dayData.houseCleaning);
            createSelect('edit-shopping', 'Shopping', family.adults.filter(p=>p!=='Mathilde'&&p!=='Marie'&&p!=='Ankie'), true, dayData.shopping);
            createSelect('edit-dressing', 'Dressing Table', family.taskableChildren, true, dayData.dressing);
            createSelect('edit-cleaning', 'Cleaning Table', family.taskableChildren, true, dayData.cleaning);
            
            el('edit-task-modal').classList.remove('hidden');
        }

        async function saveEditChanges() {
            const oldData = JSON.parse(JSON.stringify(appData.schedule[currentDayIndex]));
            const newData = appData.schedule[currentDayIndex];
            
            const getSelected = (id) => Array.from(el(id).selectedOptions).map(o => o.value);
            
            newData.cooking = getSelected('edit-cooking');
            newData.houseCleaning = getSelected('edit-houseCleaning')[0] || '';
            newData.shopping = getSelected('edit-shopping');
            newData.dressing = getSelected('edit-dressing');
            newData.cleaning = getSelected('edit-cleaning');
            
            logChanges(oldData, newData);
            await saveDataToFirestore();
            el('edit-task-modal').classList.add('hidden');
        }

        function logChanges(old, aNew) {
            const date = formatDate(old.date);
            const changed = (task, before, after) => {
                const bStr = (Array.isArray(before) ? before : (before ? [before] : [])).filter(Boolean).sort().join(', ') || 'none';
                const aStr = (Array.isArray(after) ? after : (after ? [after] : [])).filter(Boolean).sort().join(', ') || 'none';
                if(bStr !== aStr) {
                    appData.history.push({
                        user: currentUserName,
                        timestamp: new Date().toISOString(),
                        change: `On ${date}, ${currentUserName} changed ${task} from [${bStr}] to [${aStr}].`
                    });
                }
            };
            changed('Cooking', old.cooking, aNew.cooking);
            changed('House Cleaning', old.houseCleaning, aNew.houseCleaning);
            changed('Shopping', old.shopping, aNew.shopping);
            changed('Dressing', old.dressing, aNew.dressing);
            changed('Cleaning', old.cleaning, aNew.cleaning);
        }

        function renderChangeLog() {
            const logEl = el('changelog-log');
            logEl.innerHTML = '';
            if(!appData.history || appData.history.length === 0) {
                logEl.innerHTML = '<p>No changes have been made.</p>';
                return;
            }
            [...appData.history].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp)).forEach(entry => {
                logEl.innerHTML += `<div class="p-2 border-b"><p class="font-semibold">${entry.change}</p><p class="text-xs text-slate-500">${formatDateTime(entry.timestamp)} by ${entry.user}</p></div>`;
            });
        }
        
        function formatDate(dateString, options = {}) {
            const date = new Date(dateString);
            const defaultOptions = { day: '2-digit', month: '2-digit', year: 'numeric', timeZone: 'UTC', ...options };
            return new Intl.DateTimeFormat('fr-FR', defaultOptions).format(date);
        }

        function formatDateTime(dateString) {
            const date = new Date(dateString);
            const options = { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit', timeZone: 'Europe/Paris' };
            return new Intl.DateTimeFormat('fr-FR', options).format(date).replace(',', '');
        }
    </script>
</body>
</html>
